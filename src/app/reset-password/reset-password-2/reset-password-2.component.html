<div
  class="reset-password-2-container flex flex-col justify-center min-h-screen p-4"
  data-testid="reset-password-2-container"
  >
  <div
    class="reset-password-2-form-container mx-auto w-full max-w-sm"
    data-testid="reset-password-2-form-container"
    >
    <div class="text-center mb-8" data-testid="reset-password-2-header">
      <h1 class="text-3xl font-bold" data-testid="reset-password-2-title">{{ title }}</h1>
      <p class="text-gray-600 mt-2" data-testid="reset-password-2-subtitle">
        Create a new password for your account
      </p>
    </div>

    @if (!resetSuccessful() && !tokenError()) {
      <form
        (ngSubmit)="onSubmit()"
        [formGroup]="resetPasswordForm"
        class="space-y-4"
        data-testid="reset-password-2-form"
        >
        <!-- Password field -->
        <div data-testid="reset-password-2-password-field">
          <div class="relative">
            <input
              (input)="checkPasswordStrength($event)"
              [ngClass]="{'ng-invalid ng-dirty': submitted && password?.errors}"
              [type]="showPassword() ? 'text' : 'password'"
              class="w-full pr-10"
              data-testid="reset-password-2-password-input"
              formControlName="password"
              pInputText
              placeholder="New password (min. 6 characters)"
              />
            <button
              (click)="togglePasswordVisibility()"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
              data-testid="reset-password-2-toggle-password"
              type="button"
              >
              <i [ngClass]="showPassword() ? 'pi-eye-slash' : 'pi-eye'" class="pi"></i>
            </button>
          </div>
          @if (submitted && password?.errors) {
            <small
              class="text-red-500 text-xs mt-1 block"
              data-testid="reset-password-2-password-error"
              >
              @if (password?.errors?.['required']) {
                <span>Password is required</span>
              }
              @if (password?.errors?.['minlength']) {
                <span
                  >Password must be at least 6 characters</span
                  >
                }
              </small>
            }
            <!-- Password strength indicator -->
            @if (features.showPasswordStrength && password?.value) {
              <div
                class="mt-2"
                data-testid="reset-password-2-password-strength"
                >
                <div class="w-full bg-gray-200 rounded h-1.5">
                  <div
                    [style.background-color]="getPasswordStrengthColor()"
                    [style.width]="(passwordStrength() * 20) + '%'"
                    class="h-1.5 rounded"
                    data-testid="reset-password-2-strength-bar"
                  ></div>
                </div>
                <div class="flex justify-between mt-1">
                  <span
                    [style.color]="getPasswordStrengthColor()"
                    class="text-xs"
                    data-testid="reset-password-2-strength-label"
                    >
                    {{ getPasswordStrengthLabel() }}
                  </span>
                  <span class="text-xs text-gray-500" data-testid="reset-password-2-strength-score">
                    {{ passwordStrength() }}/5
                  </span>
                </div>
              </div>
            }
          </div>
          <!-- Confirm Password field -->
          <div data-testid="reset-password-2-confirm-password-field">
            <input
              [ngClass]="{'ng-invalid ng-dirty': submitted && confirmPassword?.errors}"
              class="w-full"
              data-testid="reset-password-2-confirm-password-input"
              formControlName="confirmPassword"
              pInputText
              placeholder="Confirm password"
              type="password"
              />
            @if (submitted && (confirmPassword?.errors || resetPasswordForm.errors?.['mismatch'])) {
              <small
                class="text-red-500 text-xs mt-1 block"
                data-testid="reset-password-2-confirm-password-error"
                >
                @if (confirmPassword?.errors?.['required']) {
                  <span>Please confirm your password</span>
                }
                @if (resetPasswordForm.errors?.['mismatch']) {
                  <span>Passwords do not match</span>
                }
              </small>
            }
          </div>
          <!-- Error message if provided -->
          @if (resetError) {
            <div
              class="text-red-500 text-sm mt-2"
              data-testid="reset-password-2-error"
              >
              {{ resetError }}
            </div>
          }
          <button
            [disabled]="resetPasswordForm.invalid || isSubmitting"
            [loading]="isSubmitting()"
            aria-label="Reset Password"
            class="w-full mt-4"
            data-testid="reset-password-2-submit-button"
            label="Reset Password"
            pButton
            type="submit"
          ></button>
        </form>
      }

      @if (tokenError()) {
        <div class="text-center py-8" data-testid="reset-password-2-token-error">
          <div class="inline-block p-4 rounded-full bg-yellow-100 mb-4">
            <i class="pi pi-exclamation-triangle text-yellow-500 text-4xl"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Invalid Link</h3>
          <p class="text-gray-600 mb-6">
            This password reset link is invalid or has expired. Please request a new password reset
            link.
          </p>
          <button
            (click)="navigateToForgotPassword()"
            aria-label="Request New Link"
            class="w-full"
            data-testid="reset-password-2-request-button"
            label="Request New Link"
            pButton
            type="button"
          ></button>
        </div>
      }

      @if (resetSuccessful()) {
        <div class="text-center py-8" data-testid="reset-password-2-success">
          <div class="inline-block p-4 rounded-full bg-green-100 mb-4">
            <i class="pi pi-check-circle text-green-500 text-4xl"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Success!</h3>
          <p class="text-gray-600 mb-6">
            Your password has been reset successfully. You can now log in with your new password.
          </p>
          <button
            (click)="navigateToLogin()"
            aria-label="Go to Login"
            class="w-full"
            data-testid="reset-password-2-login-button"
            label="Go to Login"
            pButton
            type="button"
          ></button>
        </div>
      }
    </div>
  </div>

  <p-toast />
